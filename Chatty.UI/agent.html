<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Agent Chat Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://static.thenounproject.com/png/4971895-200.png" type="image/png" />
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <div class="flex-1">
        <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-lg p-6 space-y-4">
            <h2 class="text-xl font-bold text-blue-600">Agent Chat Panel</h2>

            <div>
                <h3 class="text-md font-semibold text-gray-700 mb-2">Active Sessions</h3>
                <ul id="session-list" class="space-y-1"></ul>
            </div>

            <div class="flex items-center gap-2">
                <input id="session-id" class="flex-1 border px-3 py-2 rounded-md"
                    placeholder="Paste or type a sessionId..." />
                <button id="join-session"
                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Join</button>
            </div>

            <div id="messages" class="h-80 overflow-y-auto bg-gray-50 border p-4 rounded space-y-2 text-sm"></div>

            <div class="flex items-center gap-2">
                <input id="message-input" class="flex-1 border px-3 py-2 rounded-md" placeholder="Type your reply..." />
                <button id="send-btn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Send</button>
            </div>
        </div>
    </div>

    <footer class="text-center text-xs text-gray-500 py-4 border-t">
        Chatty &mdash; Built with ðŸ’™ by <span class="font-semibold text-blue-600">JKC</span>
    </footer>

    <script>
        let connection;
        let sessionId = null;
        const agentUser = localStorage.getItem("agent_name");

        if (!agentUser) {
            window.location.href = "agent-login.html";
        }

        localStorage.setItem("agent_name", agentUser);

        async function startConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl(`https://localhost:7186/chat-hub?role=agent&username=${encodeURIComponent(agentUser)}`)
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            connection.on("PingCheck", () => {
                connection.invoke("PingCheck"); // This will call ChatHub.PingCheck()
            });

            connection.on("SessionEnded", sessionId => {
                const sessionEl = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (sessionEl) sessionEl.remove();
            });

            connection.on("ReceiveMessage", (fromUser, senderRole, message, incomingSessionId) => {
                const activeSessionId = localStorage.getItem("agent_session_id");

                if (incomingSessionId !== activeSessionId) return;
                if (message.includes("[System] Chat started")) return;

                const typingId = "typing-" + incomingSessionId;
                const typingDiv = document.getElementById(typingId);
                if (typingDiv) typingDiv.textContent = "";

                appendMessage(senderRole, message, new Date().toISOString(), false);
            });

            connection.on("NewSessionStarted", (sessionId, label, ipAddress) => {
                const list = document.getElementById("session-list");
                const existing = list.querySelector(`[data-session-id="${sessionId}"]`);
                if (existing) return;

                // Fetch updated assignment state
                fetch(`https://localhost:7186/api/sessions/${sessionId}`)
                    .then(res => res.json())
                    .then(session => {
                        if (session.assignedAgent && session.assignedAgent !== agentUser) {
                            return; // Don't show it if handled by another agent
                        }

                        const li = document.createElement("li");
                        li.dataset.sessionId = sessionId;

                        const btn = document.createElement("button");
                        btn.textContent = label;
                        btn.className = "text-blue-600 hover:underline";
                        btn.onclick = () => joinSession(sessionId);

                        const ip = document.createElement("span");
                        ip.textContent = ` â€“ ${ipAddress ?? "unknown"}`;
                        ip.className = "text-xs text-gray-500 ml-2";

                        const typing = document.createElement("div");
                        typing.id = `typing-${sessionId}`;
                        typing.className = "text-xs text-gray-400 ml-2";
                        typing.style.fontStyle = "italic";

                        li.appendChild(btn);
                        li.appendChild(ip);
                        li.appendChild(typing);
                        list.appendChild(li);
                    });
            });


            connection.on("ReceiveTypingText", (incomingSessionId, user, text) => {
                console.log(incomingSessionId);
                const typingId = `typing-${incomingSessionId}`;
                let typingDiv = document.getElementById(typingId);

                if (!typingDiv) {
                    const li = document.querySelector(`[data-session-id="${incomingSessionId}"]`);
                    if (!li) return;

                    typingDiv = document.createElement("div");
                    typingDiv.id = typingId;
                    typingDiv.className = "text-xs text-gray-400 ml-2";
                    typingDiv.style.fontStyle = "italic";
                    li.appendChild(typingDiv);
                }

                typingDiv.textContent = text && text.trim()
                    ? `${user} is typing: "${text}"`
                    : "";
            });
            await connection.start();

            const stored = localStorage.getItem("agent_session_id");
            if (stored) {
                await joinSession(stored);
                document.getElementById("session-id").value = stored;
            }
        }

        document.getElementById("join-session").addEventListener("click", () => {
            const id = document.getElementById("session-id").value.trim();
            if (!id) return alert("Session ID required.");
            joinSession(id);
        });

        document.getElementById("send-btn").addEventListener("click", async () => {
            const msg = document.getElementById("message-input").value.trim();
            if (!msg || !sessionId) return;
            await connection.invoke("SendMessage", sessionId, agentUser, "agent", msg);
            document.getElementById("message-input").value = "";
        });

        async function joinSession(id) {
            sessionId = id;
            localStorage.setItem("agent_session_id", sessionId);

            // Clear previous highlights
            document.querySelectorAll("#session-list li").forEach(li => {
                li.classList.remove("bg-blue-50", "font-semibold");
                const btn = li.querySelector("button");
                if (btn) btn.textContent = btn.textContent.replace(" (viewing)", "");
            });

            // Highlight current session
            const activeLi = document.querySelector(`#session-list [data-session-id="${id}"]`);
            if (activeLi) {
                activeLi.classList.add("bg-blue-50", "font-semibold");
                const btn = activeLi.querySelector("button");
                if (btn && !btn.textContent.includes("(viewing)")) {
                    btn.textContent += " (viewing)";
                }
            }

            if (connection.state !== signalR.HubConnectionState.Connected) {
                await connection.start().catch(err => {
                    console.error("Reconnection failed", err);
                    return;
                });
            }

            const res = await fetch("https://localhost:7186/api/assign-agent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sessionId, agentName: agentUser, agentConnectionId: connection.connectionId })
            });

            const result = await res.text();
            const cleaned = result.trim().toLowerCase();
            if (cleaned.includes("already handled")) {
                const assignedAgent = result.split("by")[1]?.trim().replace(/['"]+/g, "");
                if (assignedAgent !== agentUser) {
                    alert(result);
                    return;
                }
            }

            await connection.invoke("JoinSession", sessionId);

            const historyRes = await fetch(`https://localhost:7186/api/chat/${sessionId}`);
            const history = await historyRes.json();
            document.getElementById("messages").innerHTML = "";

            history.forEach(msg => {
                if (msg.message.includes("[System] Chat started")) return;
                appendMessage(msg.senderRole, msg.message, msg.sentAt);
            });

            const msg = document.createElement("div");
            msg.className = "text-center text-sm text-gray-500 mt-2";
            document.getElementById("messages").appendChild(msg);
        }

        async function loadSessions() {
            const res = await fetch("https://localhost:7186/api/sessions");
            const sessions = await res.json();
            const list = document.getElementById("session-list");
            list.innerHTML = "";

            const currentSession = localStorage.getItem("agent_session_id");

            sessions.forEach(({ sessionId, assignedAgent, label, ipAddress }) => {
                if (assignedAgent && assignedAgent !== agentUser) return;

                const li = document.createElement("li");
                li.dataset.sessionId = sessionId;

                const btn = document.createElement("button");
                const isViewing = sessionId === currentSession;

                btn.textContent = `${label}${isViewing ? " (viewing)" : ""}`;
                btn.className = `text-blue-600 hover:underline ${isViewing ? "font-bold" : ""}`;
                btn.onclick = () => joinSession(sessionId);

                const ip = document.createElement("span");
                ip.textContent = ` â€“ ${ipAddress ?? "unknown"}`;
                ip.className = "text-xs text-gray-500 ml-2";

                const typing = document.createElement("div");
                typing.id = `typing-${sessionId}`;
                typing.className = "text-xs text-gray-400 ml-2";
                typing.style.fontStyle = "italic";

                li.appendChild(btn);
                li.appendChild(ip);
                li.appendChild(typing);
                list.appendChild(li);
            });
        }

        function appendMessage(role, message, timestamp, isUtc = true) {
            const isAgent = role === "agent";
            const container = document.createElement("div");
            container.className = `flex ${isAgent ? "justify-end" : "justify-start"}`;

            const formattedTime = formatTimestamp(timestamp || new Date().toISOString(), isUtc);

            container.innerHTML = `
    <div class="relative max-w-xs px-4 py-2 rounded-lg ${isAgent ? "bg-blue-600 text-white rounded-br-none" : "bg-gray-200 text-black rounded-bl-none"}" title="${formattedTime}">
        ${message}
        <span class="absolute -bottom-1 ${isAgent ? "right-0" : "left-0"} w-0 h-0 
            ${isAgent
                    ? "border-t-[10px] border-l-[10px] border-t-blue-600 border-l-transparent"
                    : "border-t-[10px] border-r-[10px] border-t-gray-200 border-r-transparent"}">
        </span>
    </div>`;

            const msgBox = document.getElementById("messages");
            msgBox.appendChild(container);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        function formatTimestamp(isoString, isUtc = true) {
            const baseDate = new Date(isoString);
            const localDate = isUtc
                ? new Date(baseDate.getTime() + (baseDate.getTimezoneOffset() * -60000))
                : baseDate;

            const now = new Date();
            const isToday = localDate.toDateString() === now.toDateString();

            return isToday
                ? localDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : localDate.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        loadSessions().catch(console.error);
        startConnection().catch(console.error);
    </script>

</body>

</html>